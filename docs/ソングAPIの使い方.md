# ソングAPIの使い方

## はじめに

### 概要と目的

VOICEVOX v0.16からソングAPIを使って歌声を生成できます。
このドキュメントではソングAPIの基本的な使い方と音声生成の手順を説明します。

## 前提条件

### 必要なツール

- curl または他のHTTPリクエスト送信ツール

## 基本概念

### APIのアクセスポイント

#### VOICEVOX エディタ経由で起動したエンジンを使う場合

エディタ経由でエンジンを起動する場合は、通信ポート番号が変更されていることがあります。現在有効なAPIのアクセスポイントは以下のJSONファイルから確認できます：

情報ファイルの場所： ` C:\Users\(ユーザ名)\AppData\Roaming\voicevox\runtime-info.json `

``` json
{
    "formatVersion": X,
    "appVersion": "0.XX.X",
    "engineInfos": [
        {
            "uuid": "00000000-0000-0000-00000-000000000000",
            "url": "http://127.0.0.1:50021",
            "name": "VOICEVOX Engine"
        }
    ]
}
```

このURLがアクセスポイントです。

#### 直接エンジンを起動して使う場合

VOICEVOXエンジンを直接起動する場合は、エンジン規定の通信ポートが使用されます（起動時に表示されます）。

### 歌い方と歌声の指定

歌い方と歌声を指定するには、まず利用可能な話者とスタイルの情報を取得します。`http://localhost:50021/singers` にアクセスしてリストを取得します。

```json
[
  {
    "name": "波音リツ",
    "speaker_uuid": "00000000-0000-0000-0000-000000000000",
    "styles": [
      {
        "name": "クイーン",
        "id": 3065,
        "type": "frame_decode"
      },
      {
        "name": "ノーマル",
        "id": 6000,
        "type": "sing"
      }
    ],
    "version": "0.15.3"
  }
]
```

歌い方には、`type` が `sing` もしくは `singing_teacher` のIDを指定します。歌声を変える場合は、`type` が `frame_decode` のIDを指定します。

### 計算に必要な数値の取得

フレーム長の計算に必要な数値は、エンジンマニフェストから取得できます。`http://localhost:50021/engine_manifest` にアクセスします。

```json
    "default_sampling_rate": 24000,
    "frame_rate": 93.75,
```

この `frame_rate` が計算に必要な値です。

## 実装手順

### 例題とする楽譜

![楽譜](res/score_example.png)
![楽譜](res/score_example_roll.png)

### 楽譜用JSONデータの作成

例題の楽譜をソングAPIで発声する場合は、このようなJSONデータとなります。

``` bash
echo -n '{
  "notes": [
    { "key": null, "frame_length": 47, "lyric": "" },
    { "key": 60, "frame_length": 45, "lyric": "ド" },
    { "key": 62, "frame_length": 45, "lyric": "レ" },
    { "key": 64, "frame_length": 45, "lyric": "ミ" },
    { "key": null, "frame_length": 47, "lyric": "" }
  ]
}' > score.json
```

各パラメータを設定するにあたり、下記の知識が必要となります。

#### フレーム長の考え方

ソングAPIでは音符の長さをフレーム長で指定します。例えば125bpmは1分間に4分音符が125回となる速さです。秒数換算では 1÷（125÷60）＝0.48秒になります。

この秒数をフレーム長に変換するには、エンジンのフレームレートを掛けます：
`frame_length = 0.48 × 93.75 = 45.0`

数値は四捨五入し整数で指定します。

#### その他の値の決め方

- `key` は音の高さを指定します。MIDIノートナンバーとも呼ばれます。基準となるドの音＝60となります。
- `lyric` はカタカナで１モーラを指定します。nullが指定された場合は休符表現となり、無音になります。

なお、モーラとは、日本語の発音を区切る1リズム単位のことで、ひらがな・カタカナ1文字とほぼ対応します。
「ッ」「ン」「リュ」のような小さな音も、それぞれ1モーラとして数えられます。

#### 前後の空白

発声区間は音符区間より広いため、前後に余白が必要となります。余白が短い場合はぶつ切りになったり、発話がうまくできない可能性があります。

VOICEVOXエディタに合わせるなら0.5秒以上の空白を推奨します（例題のJSONにも前後に空白を入れています）。

### クエリの生成

楽譜データを歌い方データ（クエリデータ）に変換するには、以下のコマンドを実行します：

``` bash
curl -s \
    -H "Content-Type: application/json" \
    -X POST \
    -d @score.json \
    "127.0.0.1:50021/sing_frame_audio_query?speaker=6000" \
    > query.json
```

歌い方データにはフレームごとの音高や音量、音素の長さなどが含まれます。これらの値を変えることで歌い方をより細かく調整できます。  

### 歌声の生成

クエリデータを用いて歌声を生成します：

``` bash
curl -s \
    -H "Content-Type: application/json" \
    -X POST \
    -d @query.json \
    "127.0.0.1:50021/frame_synthesis?speaker=3065" \
    > audio.wav
```

## まとめ

ソングAPIを使えばサードパーティツールから歌声を生成できます。
APIの特性を理解して、VOICEVOXを効果的に活用してください。
